<?php

namespace {{ table.schema.namespace }}\Base;

{% set baseModel = 'Model' %}
{% if 'Model' == table.phpName -%}
    use Rocket\ORM\Model\Model as RocketBaseModel;
    {% set baseModel = 'BaseModel' %}
{% elseif 'BaseModel' == table.phpName -%}
    use Rocket\ORM\Model\Model as RocketBaseModel;
    {% set baseModel = 'RocketBaseModel' %}
{% else -%}
    use Rocket\ORM\Model\Model;
{% endif %}

{% block comment %}
/**
 * Generated by Rocket ORM.
 * Do not edit this file, use the generation command instead.
 *
 * "{{ table.schema.database }}.{{ table.name }}" base model
 */
{% endblock %}
class Base{{ table.phpName }} extends {{ baseModel }}
{
    {%- block attributes -%}
        {%- include 'Attribute/attribute.php.twig' -%}
    {%- endblock %}

    {%- block type_attributes -%}
        {% for column in table.columns %}
            {%- include 'Attribute/' ~ column.typeAsString ~ '.php.twig' ignore missing -%}
        {% endfor %}
        {{- "\n" -}}
    {%- endblock %}

    {%- block constructor -%}
        {%- include 'Method/__construct.php.twig' -%}
        {{- "\n" -}}
    {%- endblock constructor -%}

    {%- block hydrateDefaults -%}
        {% if table.hasDefaultColumn -%}
            {%- include 'Method/hydrate_defaults.php.twig' -%}
        {% endif %}
        {{- "\n" -}}
    {%- endblock hydrateDefaults -%}

    {%- block hydrate -%}
        {%- include 'Method/hydrate.php.twig' -%}
    {%- endblock hydrate %}

    /**
     * @param \PDO $con
     */
    protected function doInsert(\PDO $con)
    {
        $con->beginTransaction();

        $stmt = $con->prepare('INSERT INTO `{{ table.schema.database }}`.`{{ table.name }}` (
            {%- for column in table.columns -%}
                `{{ column.name }}`
                {%- if not loop.last %}, {% endif %}
            {%- endfor -%}
        ) VALUES (
            {%- for column in table.columns -%}
                :{{ column.name }}
                {%- if not loop.last %}, {% endif %}
            {%- endfor -%}
        )');

        {%- for column in table.columns -%}
            {{ "\n        " }}{% include 'PDO/bindValue.php.twig' %}
        {%- endfor -%}
        {{ "\n" }}
        $stmt->execute();

        {%- for primaryKey in table.primaryKeys -%}
            {% if primaryKey.isAutoIncrement -%}
                {{ "\n\n        " }}$this->{{ primaryKey.phpName }} = $con->lastInsertId();
            {%- endif -%}
        {%- endfor -%}
        {{ "\n        " -}}
        $this->_isNew = false;
        {{ "\n        " -}}
        $con->commit();
    }

    /**
     * @param \PDO $con
     */
    protected function doUpdate(\PDO $con)
    {
        $con->beginTransaction();

        $stmt = $con->prepare('UPDATE `{{ table.schema.database }}`.`{{ table.name }}` SET{{ ' ' }}
            {%- for column in table.columns -%}
                {%- if not column.isPrimaryKey or column.isPrimaryKey and not column.isAutoIncrement -%}
                    `{{ column.name }}` = :{{ column.name }}
                    {%- if not loop.last %}, {% endif %}
                {%- endif -%}
            {%- endfor -%}
        {{ ' ' }}WHERE{{ ' ' }}
            {%- for column in table.primaryKeys -%}
                `{{ column.name }}` = :where_{{ column.name }}
                {%- if not loop.last %} AND {% endif %}
            {%- endfor -%}
        ');

        {%- for column in table.columns -%}
            {%- if not column.isPrimaryKey or column.isPrimaryKey and not column.isAutoIncrement -%}
                {{ "\n        " }}{% include 'PDO/bindValue.php.twig' %}
            {%- endif -%}
        {%- endfor -%}
        {%- for column in table.primaryKeys -%}
            {{ "\n        " }}{% include 'PDO/bindValue.php.twig' with {'prefix': 'where_'} %}
        {%- endfor -%}
        {{ "\n" }}
        $stmt->execute();

        $con->commit();
    }

    /**
     * @param \PDO $con
     */
    protected function doDelete(\PDO $con)
    {
        $con->beginTransaction();

        $stmt = $con->prepare('DELETE FROM `{{ table.schema.database }}`.`{{ table.name }}` WHERE{{ ' ' }}
            {%- for column in table.primaryKeys -%}
                `{{ column.name }}` = :{{ column.name }}
                {%- if not loop.last %} AND {% endif %}
            {%- endfor -%}
        ');

        {%- for column in table.primaryKeys -%}
            {{ "\n        " }}{% include 'PDO/bindValue.php.twig' %}
        {%- endfor -%}

        {{ "\n" }}
        $stmt->execute();

        $con->commit();
    }

    {%- for column in table.columns -%}
        {%- include ['Method/getColumn/' ~ column.typeAsString ~ '.php.twig', 'Method/getColumn.php.twig'] -%}
        {{ "\n\n" }}
        {%- include ['Method/setColumn/' ~ column.typeAsString ~ '.php.twig', 'Method/setColumn.php.twig'] -%}
        {% if not loop.last -%}
            {{ "\n\n" }}
        {%- endif %}
    {%- endfor -%}
    {{ "\n" -}}
}
