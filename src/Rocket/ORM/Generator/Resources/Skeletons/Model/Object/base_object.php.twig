<?php

namespace {{ table.schema.namespace }}\Base;

{% set baseModel = 'Model' %}
{% if 'Model' == table.phpName -%}
    use Rocket\ORM\Model\Model as RocketBaseModel;
    {% set baseModel = 'BaseModel' %}
{% elseif 'BaseModel' == table.phpName -%}
    use Rocket\ORM\Model\Model as RocketBaseModel;
    {% set baseModel = 'RocketBaseModel' %}
{% else -%}
    use Rocket\ORM\Model\Model;
{% endif %}

{% block comment %}
/**
 * Generated by Rocket ORM.
 * Do not edit this file, use the generation command instead.
 *
 * "{{ table.schema.database }}.{{ table.name }}" base model
 */
{% endblock %}
class Base{{ table.phpName }} extends {{ baseModel }}
{
    {%- block attributes -%}
        {% for column in table.columns -%}
            {{ "\n    " -}}
            {{ column.attributePhpDoc }}
            {{- "\n    " -}}
            protected ${{ column.phpName }};
            {{- "\n" -}}
        {% endfor %}
        {{- "\n" -}}
    {%- endblock %}

    {%- block constructor -%}
        {%- include 'Method/__construct.php.twig' -%}
        {{- "\n" -}}
    {%- endblock constructor -%}

    {%- block hydrateDefaults -%}
        {% if table.hasDefaultColumn -%}
            {%- include 'Method/hydrate_defaults.php.twig' -%}
        {% endif %}
        {{- "\n" -}}
    {%- endblock hydrateDefaults -%}

    {%- block hydrate -%}
        {%- include 'Method/hydrate.php.twig' -%}
    {%- endblock hydrate %}

    /**
     * @param \PDO $con
     */
    protected function doInsert(\PDO $con)
    {
        $con->beginTransaction();

        $stmt = $con->prepare('INSERT INTO `{{ table.schema.database }}`.`{{ table.name }}` (
            {%- for column in table.columns -%}
                `{{ column.name }}`
                {%- if not loop.last %}, {% endif %}
            {%- endfor -%}
        ) VALUES (
            {%- for column in table.columns -%}
                :{{ column.name }}
                {%- if not loop.last %}, {% endif %}
            {%- endfor -%}
        )');

        {%- for column in table.columns -%}
            {{ "\n        " }}$stmt->bindValue(':{{ column.name }}', $this->{{ column.phpName }}, \PDO::PARAM_{{ constant('\\Rocket\\ORM\\Model\\Map\\TableMap::COLUMN_TYPE_INTEGER') == column.type ? 'INT' : 'STR' }});
        {%- endfor -%}
        {{ "\n" }}
        $stmt->execute();

        {%- for primaryKey in table.primaryKeys -%}
            {% if primaryKey.isAutoIncrement -%}
                {{ "\n\n        " }}$this->{{ primaryKey.phpName }} = $con->lastInsertId();
            {%- endif -%}
        {%- endfor -%}
        {{ "\n        " -}}
        $this->_isNew = false;
        {{ "\n        " -}}
        $con->commit();
    }

    /**
     * @param \PDO $con
     */
    protected function doUpdate(\PDO $con)
    {
        $con->beginTransaction();

        $stmt = $con->prepare('UPDATE `{{ table.schema.database }}`.`{{ table.name }}` SET{{ ' ' }}
            {%- for column in table.columns -%}
                {%- if not column.isPrimaryKey or column.isPrimaryKey and not column.isAutoIncrement -%}
                    `{{ column.name }}` = :{{ column.name }}
                    {%- if not loop.last %}, {% endif %}
                {%- endif -%}
            {%- endfor -%}
        {{ ' ' }}WHERE{{ ' ' }}
            {%- for column in table.primaryKeys -%}
                `{{ column.name }}` = :where_{{ column.name }}
                {%- if not loop.last %} AND {% endif %}
            {%- endfor -%}
        ');

        {%- for column in table.columns -%}
            {%- if not column.isPrimaryKey or column.isPrimaryKey and not column.isAutoIncrement -%}
                {{ "\n        " }}$stmt->bindValue(':{{ column.name }}', $this->{{ column.phpName }}, \PDO::PARAM_{{ constant('\\Rocket\\ORM\\Model\\Map\\TableMap::COLUMN_TYPE_INTEGER') == column.type ? 'INT' : 'STR' }});
            {%- endif -%}
        {%- endfor -%}
        {%- for column in table.primaryKeys -%}
            {{ "\n        " }}$stmt->bindValue(':where_{{ column.name }}', $this->{{ column.phpName }}, \PDO::PARAM_{{ constant('\\Rocket\\ORM\\Model\\Map\\TableMap::COLUMN_TYPE_INTEGER') == column.type ? 'INT' : 'STR' }});
        {%- endfor -%}
        {{ "\n" }}
        $stmt->execute();

        $con->commit();
    }

    {%- for column in table.columns -%}
        {{ "\n\n    " }}/**
     * @return {{ column.typeAsPhpDoc }}
     */
    public function get{{ column.methodName }}()
    {
        return $this->{{ column.phpName }};
    }

    /**
     * @param {{ column.typeAsPhpDoc }} ${{ column.phpName }}
     *
     * @return $this
     */
    public function set{{ column.methodName }}(${{ column.phpName }})
    {
        $this->{{ column.phpName }} = ${{ column.phpName }};

        return $this;
    }
    {%- endfor %}

}
