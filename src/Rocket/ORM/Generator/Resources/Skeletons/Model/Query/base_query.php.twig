<?php

namespace {{ table.schema.namespace }}\Base;

use Rocket\ORM\Rocket;
{% block use_query %}use Rocket\ORM\Model\Query\Query;{%- endblock %}

/**
 * Generated by Rocket ORM.
 * Do not edit this file, use the generation command instead.
 *
 * "{{ table.schema.database }}.{{ table.name }}" base query model
 */
class Base{{ table.phpName }}Query extends Query
{
    const MODEL_NAMESPACE = '\\{{ table.schema.escapedNamespace }}\\{{ table.phpName }}';

    /**
     * @param string $alias The query alias
     *
     * @return \{{ table.schema.namespace }}\{{ table.phpName }}Query
     */
    public static function create($alias = '{{ table.phpName }}')
    {
        return new static($alias, self::MODEL_NAMESPACE);
    }

    /**
     * @return string
     */
    protected function buildQuery()
    {
        $query = 'SELECT '
            {% for i,column in table.columns -%}
            {%- if loop.last -%}
                . $this->alias . '.{{ column.name }}'
            {%- else -%}
                . $this->alias . '.{{ column.name }}, '
            {% endif -%}
        {%- endfor -%}
        {{ "\n        " }};

        $hasRelationWith = 0 < sizeof($this->with);
        if ($hasRelationWith) {
            $query .= $this->buildRelationWith();
        }

        $query .= ' {% block find_query_from %}FROM `{{ table.schema.database }}`.`{{ table.name }}` AS ' . $this->alias{%- endblock %};

        if (0 < sizeof($this->joins)) {
            $query .= $this->buildRelationClauses();
        }

        // Has clauses ?
        if (0 < sizeof($this->clauses)) {
            $query .= $this->buildClauses();
        }

        $query .= $this->buildLimit();

        return $query;
    }

    /**
     * @param \PDO $con
     *
     * @return array
     *
     * @throws \Exception
     */
    public function find(\PDO $con = null)
    {
        // Building query
        $query = $this->buildQuery(); {#- create a variable to let behaviors to override below #}

        // Processing
        try {
            if (null == $con) {
                $con = Rocket::getConnection($this->getTableMap()->getConnectionName());
            }

            $stmt = $con->prepare($query);

            // Has clauses ?
            if (0 < sizeof($this->clauses)) {
                foreach ($this->clauses as $i => $clauseParams) {
                    $stmt->bindValue(':param_' . $i, $clauseParams['value'], \PDO::PARAM_STR);
                }
            }

            $stmt->execute();
        } catch (\Exception $e) {
            throw $e;
        }

        $objects = $this->hydrate($stmt);

        $this->clear();

        return $objects;
    }
}
